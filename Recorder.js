/*UNPKG
opus-encdec (A.K.A. Recorder)
Version: 
0.1.1
A JavaScript library for encoding and decoding OPUS audio

opus-encdec / dist / libopus-encoder.wasm.js
AND
opus-encdec / src / OggOpusEncoder.js

combined and minified
*/

// https://github.com/mmig/opus-encdec/blob/master/LICENSE.md

var Module=void 0!==Module?Module:{locateFile:p=>'./libopus-encoder.wasm.wasm'};!function(e,n,t){var r,o;"function"==typeof define&&define.amd?define(["require"],(function(t){return r=n(e,t)})):"object"==typeof module&&module.exports?(o="undefined"!=typeof process&&process&&process.env?process.env:e,r=n(o,module.require),module.exports=r):(r=n(e),e.OpusEncoderLib=r)}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:this,(function(e,n){"use strict";var t={isReady:!1,onready:null,onRuntimeInitialized:function(){t.isReady=!0,t.onready&&setTimeout(t.onready,0)}};e&&e.OPUS_SCRIPT_LOCATION&&(t.locateFile=function(n){var t=e.OPUS_SCRIPT_LOCATION||"";return t[n]?t[n]:(t+=t&&!/\/$/.test(t)?"/":"")+n});var r,o={};for(r in t)t.hasOwnProperty(r)&&(o[r]=t[r]);var i,s,a=[],u=!1,f=!1;u="object"==typeof window,f="function"==typeof importScripts,i="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,s=!u&&!i&&!f;var c,p,l,d,m="";i?(m=f?n("path").dirname(m)+"/":__dirname+"/",c=function(e,t){return l||(l=n("fs")),d||(d=n("path")),e=d.normalize(e),l.readFileSync(e,t?null:"utf8")},p=function(e){var n=c(e,!0);return n.buffer||(n=new Uint8Array(n)),w(n.buffer),n},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),a=process.argv.slice(2),"undefined"!=typeof module&&(module.exports=t),process.on("uncaughtException",(function(e){if(!(e instanceof G))throw e})),process.on("unhandledRejection",U),function(e){process.exit(e)},t.inspect=function(){return"[Emscripten Module object]"}):s?("undefined"!=typeof read&&(c=function(e){return read(e)}),p=function(e){var n;return"function"==typeof readbuffer?new Uint8Array(readbuffer(e)):(w("object"==typeof(n=read(e,"binary"))),n)},"undefined"!=typeof scriptArgs?a=scriptArgs:void 0!==arguments&&(a=arguments),"function"==typeof quit&&function(e){quit(e)},"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)):(u||f)&&(f?m=self.location.href:"undefined"!=typeof document&&document.currentScript&&(m=document.currentScript.src),m=0!==m.indexOf("blob:")?m.substr(0,m.lastIndexOf("/")+1):"",c=function(e){var n=new XMLHttpRequest;return n.open("GET",e,!1),n.send(null),n.responseText},f&&(p=function(e){var n=new XMLHttpRequest;return n.open("GET",e,!1),n.responseType="arraybuffer",n.send(null),new Uint8Array(n.response)}),function(e,n,t){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200==r.status||0==r.status&&r.response?n(r.response):t()},r.onerror=t,r.send(null)});var y=t.print||console.log.bind(console),_=t.printErr||console.warn.bind(console);for(r in o)o.hasOwnProperty(r)&&(t[r]=o[r]);o=null,t.arguments&&(a=t.arguments),t.thisProgram&&t.thisProgram,t.quit&&t.quit;var v;t.wasmBinary&&(v=t.wasmBinary);var h;t.noExitRuntime;"object"!=typeof WebAssembly&&U("no native wasm support detected");var g=!1;function w(e,n){e||U("Assertion failed: "+n)}var b="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function R(e,n,t){for(var r=n+t,o=n;e[o]&&!(o>=r);)++o;if(o-n>16&&e.subarray&&b)return b.decode(e.subarray(n,o));for(var i="";n<o;){var s=e[n++];if(128&s){var a=63&e[n++];if(192!=(224&s)){var u=63&e[n++];if((s=224==(240&s)?(15&s)<<12|a<<6|u:(7&s)<<18|a<<12|u<<6|63&e[n++])<65536)i+=String.fromCharCode(s);else{var f=s-65536;i+=String.fromCharCode(55296|f>>10,56320|1023&f)}}else i+=String.fromCharCode((31&s)<<6|a)}else i+=String.fromCharCode(s)}return i}function A(e,n){return e?R(I,e,n):""}var I,x;"undefined"!=typeof TextDecoder&&new TextDecoder("utf-16le");t.INITIAL_MEMORY;var E,S=[],T=[],O=[],M=[];T.push({func:function(){B()}});var P=0,C=null,H=null;function U(e){throw t.onAbort&&t.onAbort(e),_(e+=""),g=!0,1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.",new WebAssembly.RuntimeError(e)}function j(e,n){return String.prototype.startsWith?e.startsWith(n):0===e.indexOf(n)}t.preloadedImages={},t.preloadedAudios={};var L,W="libopus-encoder.wasm.wasm";function k(e){try{if(e==W&&v)return new Uint8Array(v);if(p)return p(e);throw"sync fetching of the wasm failed: you can preload it to Module['wasmBinary'] manually, or emcc.py will do that for you when generating HTML (but not JS)"}catch(e){U(e)}}function q(e){for(;e.length>0;){var n=e.shift();if("function"!=typeof n){var r=n.func;"number"==typeof r?void 0===n.arg?E.get(r)():E.get(r)(n.arg):r(void 0===n.arg?null:n.arg)}else n(t)}}j(W,"data:application/octet-stream;base64,")||(L=W,W=t.locateFile?t.locateFile(L,m):m+L);var D={mappings:{},buffers:[null,[],[]],printChar:function(e,n){var t=D.buffers[e];0===n||10===n?((1===e?y:_)(R(t,0)),t.length=0):t.push(n)},varargs:void 0,get:function(){return D.varargs+=4,x[D.varargs-4>>2]},getStr:function(e){return A(e)},get64:function(e,n){return e}};var F,z={abort:function(){U()},emscripten_memcpy_big:function(e,n,t){I.copyWithin(e,n,n+t)},emscripten_resize_heap:function(e){U("OOM")},fd_close:function(e){return 0},fd_seek:function(e,n,t,r,o){},fd_write:function(e,n,t,r){for(var o=0,i=0;i<t;i++){for(var s=x[n+8*i>>2],a=x[n+(8*i+4)>>2],u=0;u<a;u++)D.printChar(e,I[s+u]);o+=a}return x[r>>2]=o,0},setTempRet0:function(e){0|e}},N=function(){var e={env:z,wasi_snapshot_preview1:z};function n(e,n){var r,o=e.exports;t.asm=o,h=t.asm.memory,r=h.buffer,r,t.HEAP8=new Int8Array(r),t.HEAP16=new Int16Array(r),t.HEAP32=x=new Int32Array(r),t.HEAPU8=I=new Uint8Array(r),t.HEAPU16=new Uint16Array(r),t.HEAPU32=new Uint32Array(r),t.HEAPF32=new Float32Array(r),t.HEAPF64=new Float64Array(r),E=t.asm.__indirect_function_table,function(e){if(P--,t.monitorRunDependencies&&t.monitorRunDependencies(P),0==P&&(null!==C&&(clearInterval(C),C=null),H)){var n=H;H=null,n()}}()}if(P++,t.monitorRunDependencies&&t.monitorRunDependencies(P),t.instantiateWasm)try{return t.instantiateWasm(e,n)}catch(e){return _("Module.instantiateWasm callback failed with error: "+e),!1}var r=function(e,n){var t,r,o;try{o=k(e),r=new WebAssembly.Module(o),t=new WebAssembly.Instance(r,n)}catch(e){var i=e.toString();throw _("failed to compile wasm module: "+i),(i.indexOf("imported Memory")>=0||i.indexOf("memory import")>=0)&&_("Memory size incompatibility issues may be due to changing INITIAL_MEMORY at runtime to something too large. Use ALLOW_MEMORY_GROWTH to allow any size memory (and also make sure not to set INITIAL_MEMORY at runtime to something smaller than it was at compile time)."),e}return[t,r]}(W,e);return n(r[0],r[1]),t.asm}(),B=t.___wasm_call_ctors=N.__wasm_call_ctors;t._opus_encoder_create=N.opus_encoder_create,t._opus_encode_float=N.opus_encode_float,t._opus_encoder_ctl=N.opus_encoder_ctl,t._opus_encoder_destroy=N.opus_encoder_destroy,t._speex_resampler_init=N.speex_resampler_init,t._speex_resampler_destroy=N.speex_resampler_destroy,t._speex_resampler_process_interleaved_float=N.speex_resampler_process_interleaved_float,t.___errno_location=N.__errno_location,t.stackSave=N.stackSave,t.stackRestore=N.stackRestore,t.stackAlloc=N.stackAlloc,t._malloc=N.malloc,t._free=N.free,t.dynCall_jiji=N.dynCall_jiji;function G(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function Y(e){function n(){F||(F=!0,t.calledRun=!0,g||(!0,q(T),q(O),t.onRuntimeInitialized&&t.onRuntimeInitialized(),function(){if(t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;)e=t.postRun.shift(),M.unshift(e);var e;q(M)}()))}e=e||a,P>0||(!function(){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)e=t.preRun.shift(),S.unshift(e);var e;q(S)}(),P>0||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),n()}),1)):n()))}if(H=function e(){F||Y(),F||(H=e)},t.run=Y,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);t.preInit.length>0;)t.preInit.pop()();return Y(),t}));
let exports={};var OggOpusEncoder=function(e,t){if(!t)throw new Error("Module with exports required to initialize an encoder instance");this.config=Object.assign({encoderApplication:2049,encoderFrameSize:20,encoderSampleRate:48e3,maxFramesPerPage:40,numberOfChannels:1,originalSampleRate:44100,resampleQuality:3,serial:Math.floor(4294967296*Math.random())},e),this.rawOpus="boolean"==typeof this.config.rawOpus?this.config.rawOpus:/^audio\/opus\b/i.test(this.config.mimeType);var s=!this.rawOpus;this._opus_encoder_create=t._opus_encoder_create,this._opus_encoder_destroy=t._opus_encoder_destroy,this._opus_encoder_ctl=t._opus_encoder_ctl,this._speex_resampler_process_interleaved_float=t._speex_resampler_process_interleaved_float,this._speex_resampler_init=t._speex_resampler_init,this._speex_resampler_destroy=t._speex_resampler_destroy,this._opus_encode_float=t._opus_encode_float,this._free=t._free,this._malloc=t._malloc,this.HEAPU8=t.HEAPU8,this.HEAP32=t.HEAP32,this.HEAPF32=t.HEAPF32,this.pageIndex=0,this.granulePosition=0,this.segmentData=s?new Uint8Array(65025):new Uint8Array(255),this.segmentDataIndex=0,this.segmentTable=s?new Uint8Array(255):null,this.segmentTableIndex=0,this.framesInPage=0,this.encodedData=s?void 0:[],this.encodedDataLength=0,this.isReady=t.isReady,this.isReady||(t.onready=function(){this.isReady=!0,this.onready&&this.onready()}),s&&this.initChecksumTable(),this.initCodec(),this.initResampler(),1===this.config.numberOfChannels&&(this.interleave=function(e){return e[0]})};OggOpusEncoder.prototype.encode=function(e){this.bufferLength||(this.bufferLength=e[0].length,this.interleavedBuffers=new Float32Array(this.bufferLength*this.config.numberOfChannels));for(var t=!this.rawOpus,s=this.interleave(e),n=0,i=t?[]:null,r=this.resampler?this.resampleBufferLength:this.encoderBufferLength,a=this.resampler?this.resampleBuffer:this.encoderBuffer;n<s.length;){var h=Math.min(r-this.sampleBufferIndex,s.length-n);if(a.set(s.subarray(n,n+h),this.sampleBufferIndex),n+=h,this.sampleBufferIndex+=h,this.sampleBufferIndex===r){this.resampler&&this._speex_resampler_process_interleaved_float(this.resampler,this.resampleBufferPointer,this.resampleSamplesPerChannelPointer,this.encoderBufferPointer,this.encoderSamplesPerChannelPointer);var o=this._opus_encode_float(this.encoder,this.encoderBufferPointer,this.encoderSamplesPerChannel,this.encoderOutputPointer,this.encoderOutputMaxLength);t?(i.concat(this.segmentPacket(o)),this.framesInPage++,this.framesInPage>=this.config.maxFramesPerPage&&i.push(this.generatePage())):(this.encodedData.push(new Uint8Array(this.encoderOutputBuffer.subarray(0,o))),this.encodedDataLength+=o),this.sampleBufferIndex=0}}return i},OggOpusEncoder.prototype.destroy=function(){this.encoder&&(this._free(this.encoderSamplesPerChannelPointer),delete this.encoderSamplesPerChannelPointer,this._free(this.encoderBufferPointer),delete this.encoderBufferPointer,this._free(this.encoderOutputPointer),delete this.encoderOutputPointer,this._opus_encoder_destroy(this.encoder),delete this.encoder,this.resampler&&(this._free(this.resampleSamplesPerChannelPointer),delete this.resampleSamplesPerChannelPointer,this._free(this.resampleBufferPointer),delete this.resampleBufferPointer,this._speex_resampler_destroy(this.resampler),delete this.resampler),this.encodedData&&(this.encodedData=null))},OggOpusEncoder.prototype.flush=function(){var e;return this.framesInPage&&(e=this.generatePage()),this.sampleBufferIndex=0,e},OggOpusEncoder.prototype.encodeFinalFrame=function(){var e=!this.rawOpus,t=e?[]:null;if(this.sampleBufferIndex>0)for(var s=(this.resampleBufferLength-this.sampleBufferIndex)/this.config.numberOfChannels,n=Math.ceil(s/this.bufferLength),i=0;i<n;i++){for(var r=[],a=0;a<this.config.numberOfChannels;a++)r.push(new Float32Array(this.bufferLength));e?t.concat(this.encode(r)):this.encode(r)}if(e)return this.headerType+=4,t.push(this.generatePage()),t},OggOpusEncoder.prototype.getChecksum=function(e){for(var t=0,s=0;s<e.length;s++)t=t<<8^this.checksumTable[t>>>24&255^e[s]];return t>>>0},OggOpusEncoder.prototype.generateCommentPage=function(){var e=new DataView(this.segmentData.buffer);if(e.setUint32(0,1937076303,!0),e.setUint32(4,1936154964,!0),e.setUint32(8,10,!0),e.setUint32(12,1868784978,!0),e.setUint32(16,1919247474,!0),e.setUint16(20,21322,!0),e.setUint32(22,0,!0),!this.rawOpus)return this.segmentTableIndex=1,this.segmentDataIndex=this.segmentTable[0]=26,this.headerType=0,this.generatePage();this.encodedData.push(new Uint8Array(this.segmentData.subarray(0,26))),this.encodedDataLength+=26},OggOpusEncoder.prototype.generateIdPage=function(){var e=new DataView(this.segmentData.buffer);if(e.setUint32(0,1937076303,!0),e.setUint32(4,1684104520,!0),e.setUint8(8,1,!0),e.setUint8(9,this.config.numberOfChannels,!0),e.setUint16(10,3840,!0),e.setUint32(12,this.config.originalSampleRateOverride||this.config.originalSampleRate,!0),e.setUint16(16,0,!0),e.setUint8(18,0,!0),!this.rawOpus)return this.segmentTableIndex=1,this.segmentDataIndex=this.segmentTable[0]=19,this.headerType=2,this.generatePage();this.encodedData.push(new Uint8Array(this.segmentData.subarray(0,19))),this.encodedDataLength+=19},OggOpusEncoder.prototype.generatePage=function(){var e=this.lastPositiveGranulePosition===this.granulePosition?-1:this.granulePosition,t=new ArrayBuffer(27+this.segmentTableIndex+this.segmentDataIndex),s=new DataView(t),n=new Uint8Array(t);s.setUint32(0,1399285583,!0),s.setUint8(4,0,!0),s.setUint8(5,this.headerType,!0),s.setUint32(6,e,!0),e<0?s.setInt32(10,Math.ceil(e/4294967297)-1,!0):s.setInt32(10,Math.floor(e/4294967296),!0),s.setUint32(14,this.config.serial,!0),s.setUint32(18,this.pageIndex++,!0),s.setUint8(26,this.segmentTableIndex,!0),n.set(this.segmentTable.subarray(0,this.segmentTableIndex),27),n.set(this.segmentData.subarray(0,this.segmentDataIndex),27+this.segmentTableIndex),s.setUint32(22,this.getChecksum(n),!0);var i={message:"page",page:n,samplePosition:this.granulePosition};return this.segmentTableIndex=0,this.segmentDataIndex=0,this.framesInPage=0,e>0&&(this.lastPositiveGranulePosition=e),i},OggOpusEncoder.prototype.initChecksumTable=function(){this.checksumTable=[];for(var e=0;e<256;e++){for(var t=e<<24,s=0;s<8;s++)t=0!=(2147483648&t)?t<<1^79764919:t<<1;this.checksumTable[e]=4294967295&t}},OggOpusEncoder.prototype.setOpusControl=function(e,t){var s=this._malloc(4);this.HEAP32[s>>2]=t,this._opus_encoder_ctl(this.encoder,e,s),this._free(s)},OggOpusEncoder.prototype.initCodec=function(){var e=this._malloc(4);this.encoder=this._opus_encoder_create(this.config.encoderSampleRate,this.config.numberOfChannels,this.config.encoderApplication,e),this._free(e),this.config.encoderBitRate&&this.setOpusControl(4002,this.config.encoderBitRate),this.config.encoderComplexity&&this.setOpusControl(4010,this.config.encoderComplexity),this.encoderSamplesPerChannel=this.config.encoderSampleRate*this.config.encoderFrameSize/1e3,this.encoderSamplesPerChannelPointer=this._malloc(4),this.HEAP32[this.encoderSamplesPerChannelPointer>>2]=this.encoderSamplesPerChannel,this.sampleBufferIndex=0,this.encoderBufferLength=this.encoderSamplesPerChannel*this.config.numberOfChannels,this.encoderBufferPointer=this._malloc(4*this.encoderBufferLength),this.encoderBuffer=this.HEAPF32.subarray(this.encoderBufferPointer>>2,(this.encoderBufferPointer>>2)+this.encoderBufferLength),this.encoderOutputMaxLength=4e3,this.encoderOutputPointer=this._malloc(this.encoderOutputMaxLength),this.encoderOutputBuffer=this.HEAPU8.subarray(this.encoderOutputPointer,this.encoderOutputPointer+this.encoderOutputMaxLength)},OggOpusEncoder.prototype.initResampler=function(){if(this.config.originalSampleRate!==this.config.encoderSampleRate){var e=this._malloc(4);this.resampler=this._speex_resampler_init(this.config.numberOfChannels,this.config.originalSampleRate,this.config.encoderSampleRate,this.config.resampleQuality,e),this._free(e),this.resampleSamplesPerChannel=this.config.originalSampleRate*this.config.encoderFrameSize/1e3,this.resampleSamplesPerChannelPointer=this._malloc(4),this.HEAP32[this.resampleSamplesPerChannelPointer>>2]=this.resampleSamplesPerChannel,this.resampleBufferLength=this.resampleSamplesPerChannel*this.config.numberOfChannels,this.resampleBufferPointer=this._malloc(4*this.resampleBufferLength),this.resampleBuffer=this.HEAPF32.subarray(this.resampleBufferPointer>>2,(this.resampleBufferPointer>>2)+this.resampleBufferLength)}else this.resampler=null},OggOpusEncoder.prototype.interleave=function(e){for(var t=0;t<this.bufferLength;t++)for(var s=0;s<this.config.numberOfChannels;s++)this.interleavedBuffers[t*this.config.numberOfChannels+s]=e[s][t];return this.interleavedBuffers},OggOpusEncoder.prototype.segmentPacket=function(e){for(var t=0,s=[];e>=0;){255===this.segmentTableIndex&&(s.push(this.generatePage()),this.headerType=1);var n=Math.min(e,255);this.segmentTable[this.segmentTableIndex++]=n,this.segmentData.set(this.encoderOutputBuffer.subarray(t,t+n),this.segmentDataIndex),this.segmentDataIndex+=n,t+=n,e-=255}return this.granulePosition+=48*this.config.encoderFrameSize,255===this.segmentTableIndex&&(s.push(this.generatePage()),this.headerType=0),s};
