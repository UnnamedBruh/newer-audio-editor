const Shine = (function() {
	const AMPEG = 0x1ad;
	const WAVE = 0xfb1;
	const DATA = 0xffd;

	const config = Object.create(null);
	const DISK = Object.create(null);

const PI =        3.14159265358979;
const PI4 =       0.78539816339745;
const PI12 =      0.26179938779915;
const PI36 =      0.087266462599717;
const PI64 =      0.049087385212;
const SQRT2 =     1.41421356237;
const LN2 =       0.69314718;
const LN_TO_LOG10=0.2302585093;
const BLKSIZE =   1024;
const HAN_SIZE =  512;
const SCALE_BLOCK=12;
const SCALE_RANGE=64;
const SCALE =     32768;
const SBLIMIT =   32;

const WAVE_RIFF_PCM=0;
const WAVE_PCM_LOHI=1;
const WAVE_PCM_HILO=2;
const WAVE_PCM_AIFF=3;
const MODE_MONO=3;

const sfBandIndex = [
  [ /* Table B.2.b: 22.05 kHz */
    new Int16Array([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576]),
    new Int16Array([0,4,8,12,18,24,32,42,56,74,100,132,174,192])
  ],
  [ /* Table B.2.c: 24 kHz */
    new Int16Array([0,6,12,18,24,30,36,44,54,66,80,96,114,136,162,194,232,278,330,394,464,540,576]),
    new Int16Array([0,4,8,12,18,26,36,48,62,80,104,136,180,192])
  ],
  [ /* Table B.2.a: 16 kHz */
    new Int16Array([0,6,12,18,24,30,36,44,45,66,80,96,116,140,168,200,238,248,336,396,464,522,576]),
    new Int16Array([0,4,8,12,18,26,36,48,62,80,104,134,174,192])
  ],
  [ /* Table B.8.b: 44.1 kHz */
    new Int16Array([0,4,8,12,16,20,24,30,36,44,52,62,74,90,110,134,162,196,238,288,342,418,576]),
    new Int16Array([0,4,8,12,16,22,30,40,52,66,84,106,136,192])
  ],
  [ /* Table B.8.c: 48 kHz */
    new Int16Array([0,4,8,12,16,20,24,30,36,42,50,60,72,88,106,128,156,190,230,276,330,384,576]),
    new Int16Array([0,4,8,12,16,22,28,38,50,64,80,100,126,192])
  ],
  [ /* Table B.8.a: 32 kHz */
    new Int16Array([0,4,8,12,16,20,24,30,36,44,54,66,82,102,126,156,194,240,296,364,448,550,576]),
    new Int16Array([0,4,8,12,16,22,30,42,58,78,104,138,180,192])
  ]
];

const enwindow = new Float64Array([ 0.000000, -0.000000, -0.000000, -0.000000, -0.000000, -0.000000, -0.000000, -0.000001, -0.000001, -0.000001,
  -0.000001, -0.000001, -0.000001, -0.000002, -0.000002, -0.000002, -0.000002, -0.000003, -0.000003, -0.000003,
  -0.000004, -0.000004, -0.000005, -0.000005, -0.000006, -0.000007, -0.000008, -0.000008, -0.000009, -0.000010,
  -0.000011, -0.000012, -0.000014, -0.000015, -0.000017, -0.000018, -0.000020, -0.000021, -0.000023, -0.000025,
  -0.000028, -0.000030, -0.000032, -0.000035, -0.000038, -0.000041, -0.000043, -0.000046, -0.000050, -0.000053,
  -0.000056, -0.000060, -0.000063, -0.000066, -0.000070, -0.000073, -0.000077, -0.000081, -0.000084, -0.000087,
  -0.000091, -0.000093, -0.000096, -0.000099,  0.000102,  0.000104,  0.000106,  0.000107,  0.000108,  0.000109,
   0.000109,  0.000108,  0.000107,  0.000105,  0.000103,  0.000099,  0.000095,  0.000090,  0.000084,  0.000078,
   0.000070,  0.000061,  0.000051,  0.000040,  0.000027,  0.000014, -0.000001, -0.000017, -0.000034, -0.000053,
  -0.000073, -0.000094, -0.000116, -0.000140, -0.000165, -0.000191, -0.000219, -0.000247, -0.000277, -0.000308,
  -0.000339, -0.000371, -0.000404, -0.000438, -0.000473, -0.000507, -0.000542, -0.000577, -0.000612, -0.000647,
  -0.000681, -0.000714, -0.000747, -0.000779, -0.000810, -0.000839, -0.000866, -0.000892, -0.000915, -0.000936,
  -0.000954, -0.000969, -0.000981, -0.000989, -0.000994, -0.000995, -0.000992, -0.000984,  0.000971,  0.000954,
   0.000931,  0.000903,  0.000869,  0.000829,  0.000784,  0.000732,  0.000674,  0.000610,  0.000539,  0.000463,
   0.000379,  0.000288,  0.000192,  0.000088, -0.000021, -0.000137, -0.000260, -0.000388, -0.000522, -0.000662,
  -0.000807, -0.000957, -0.001111, -0.001270, -0.001432, -0.001598, -0.001767, -0.001937, -0.002110, -0.002283,
  -0.002457, -0.002631, -0.002803, -0.002974, -0.003142, -0.003307, -0.003467, -0.003623, -0.003772, -0.003914,
  -0.004049, -0.004175, -0.004291, -0.004396, -0.004490, -0.004570, -0.004638, -0.004691, -0.004728, -0.004749,
  -0.004752, -0.004737, -0.004703, -0.004649, -0.004574, -0.004477, -0.004358, -0.004215, -0.004049, -0.003859,
  -0.003643, -0.003402,  0.003135,  0.002841,  0.002522,  0.002175,  0.001801,  0.001400,  0.000971,  0.000516,
   0.000033, -0.000476, -0.001012, -0.001574, -0.002162, -0.002774, -0.003411, -0.004072, -0.004756, -0.005462,
  -0.006189, -0.006937, -0.007703, -0.008487, -0.009288, -0.010104, -0.010933, -0.011775, -0.012628, -0.013489,
  -0.014359, -0.015234, -0.016113, -0.016994, -0.017876, -0.018757, -0.019634, -0.020507, -0.021372, -0.022229,
  -0.023074, -0.023907, -0.024725, -0.025527, -0.026311, -0.027074, -0.027815, -0.028533, -0.029225, -0.029890,
  -0.030527, -0.031133, -0.031707, -0.032248, -0.032755, -0.033226, -0.033660, -0.034056, -0.034413, -0.034730,
  -0.035007, -0.035242, -0.035435, -0.035586, -0.035694, -0.035759,  0.035781,  0.035759,  0.035694,  0.035586,
   0.035435,  0.035242,  0.035007,  0.034730,  0.034413,  0.034056,  0.033660,  0.033226,  0.032755,  0.032248,
   0.031707,  0.031133,  0.030527,  0.029890,  0.029225,  0.028533,  0.027815,  0.027074,  0.026311,  0.025527,
   0.024725,  0.023907,  0.023074,  0.022229,  0.021372,  0.020507,  0.019634,  0.018757,  0.017876,  0.016994,
   0.016113,  0.015234,  0.014359,  0.013489,  0.012628,  0.011775,  0.010933,  0.010104,  0.009288,  0.008487,
   0.007703,  0.006937,  0.006189,  0.005462,  0.004756,  0.004072,  0.003411,  0.002774,  0.002162,  0.001574,
   0.001012,  0.000476, -0.000033, -0.000516, -0.000971, -0.001400, -0.001801, -0.002175, -0.002522, -0.002841,
   0.003135,  0.003402,  0.003643,  0.003859,  0.004049,  0.004215,  0.004358,  0.004477,  0.004574,  0.004649,
   0.004703,  0.004737,  0.004752,  0.004749,  0.004728,  0.004691,  0.004638,  0.004570,  0.004490,  0.004396,
   0.004291,  0.004175,  0.004049,  0.003914,  0.003772,  0.003623,  0.003467,  0.003307,  0.003142,  0.002974,
   0.002803,  0.002631,  0.002457,  0.002283,  0.002110,  0.001937,  0.001767,  0.001598,  0.001432,  0.001270,
   0.001111,  0.000957,  0.000807,  0.000662,  0.000522,  0.000388,  0.000260,  0.000137,  0.000021, -0.000088,
  -0.000192, -0.000288, -0.000379, -0.000463, -0.000539, -0.000610, -0.000674, -0.000732, -0.000784, -0.000829,
  -0.000869, -0.000903, -0.000931, -0.000954,  0.000971,  0.000984,  0.000992,  0.000995,  0.000994,  0.000989,
   0.000981,  0.000969,  0.000954,  0.000936,  0.000915,  0.000892,  0.000866,  0.000839,  0.000810,  0.000779,
   0.000747,  0.000714,  0.000681,  0.000647,  0.000612,  0.000577,  0.000542,  0.000507,  0.000473,  0.000438,
   0.000404,  0.000371,  0.000339,  0.000308,  0.000277,  0.000247,  0.000219,  0.000191,  0.000165,  0.000140,
   0.000116,  0.000094,  0.000073,  0.000053,  0.000034,  0.000017,  0.000001, -0.000014, -0.000027, -0.000040,
  -0.000051, -0.000061, -0.000070, -0.000078, -0.000084, -0.000090, -0.000095, -0.000099, -0.000103, -0.000105,
  -0.000107, -0.000108, -0.000109, -0.000109, -0.000108, -0.000107, -0.000106, -0.000104,  0.000102,  0.000099,
   0.000096,  0.000093,  0.000091,  0.000087,  0.000084,  0.000081,  0.000077,  0.000073,  0.000070,  0.000066,
   0.000063,  0.000060,  0.000056,  0.000053,  0.000050,  0.000046,  0.000043,  0.000041,  0.000038,  0.000035,
   0.000032,  0.000030,  0.000028,  0.000025,  0.000023,  0.000021,  0.000020,  0.000018,  0.000017,  0.000015,
   0.000014,  0.000012,  0.000011,  0.000010,  0.000009,  0.000008,  0.000008,  0.000007,  0.000006,  0.000005,
   0.000005,  0.000004,  0.000004,  0.000003,  0.000003,  0.000003,  0.000002,  0.000002,  0.000002,  0.000002,
   0.000001,  0.000001,  0.000001,  0.000001,  0.000001,  0.000001,  0.000000,  0.000000,  0.000000,  0.000000,
   0.000000,  0.000000 ]);

	function error(s) {
		throw new Error(s);
	}

	function printf(...s) {
		if (s.length === 1) {
			console.log(s[0]);
		} else {
			let i = 1;
			console.log(s[0].replace(/%\w/g, function() {
				return s[i++];
			}));
		}
	}

	const channel_mappings = [null, "mono", "stereo"];
	const file_type = ["RIFF-WAVE PCM","RAW CD DATA PCM"];

	function wave_open(filetype, input) {
		let i = 0;
		if (filetype === DATA) i = 1;
		const file = DISK[input];
		config.wave.type          = WAVE_RIFF_PCM;
		config.wave.channels      = file.channels;
		config.wave.samplerate    = file.samp_rate;
		config.wave.bits          = file.bit_samp;
		config.wave.total_samples = file.length / file.byte_samp;
		config.wave.length        = file.length / file.byte_rate;

		printf("%s, %s %ldHz %dbit, Length: %2ld:%2ld:%2ld\n", file_type[i],channel_mappings[file.channels],file.samp_rate,file.bit_samp,config.wave.length/3600,(config.wave.length/60)%60,config.wave.length%60);
	}

	function wave_close() {};

	let raw = false;

	function print_usage() {
		printf("USAGE   :  [options] <infile> <outfile>\n");
		printf("options : -h            this help message\n");
		printf("          -b <bitrate>  set the bitrate [32-320], default 128kbit\n");
		printf("          -c            set copyright flag, default off\n");
		printf("          -r            raw cd data file instead of wave\n");
		printf("");
	}

	function set_defaults() {
		config.mpeg = Object.create(null);
		config.mpeg.type = 1;
		config.mpeg.layr = 2;
		config.mpeg.mode = 2;
		config.mpeg.bitr = 128;
		config.mpeg.psyc = 2;
		config.mpeg.emph = 0; 
		config.mpeg.crc  = 0;
		config.mpeg.ext  = 0;
		config.mpeg.mode_ext  = 0;
		config.mpeg.copyright = 0;
		config.mpeg.original  = 1;
	}

	const ASCIILOOKUP = new Uint8Array([16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,0,1,2,3,4,5,6,7,8,9,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16]);

	function __atoi(str, offset = 0) {
		const bytes = new TextEncoder().encode(str);
		let i = offset;
		for (; i < bytes.length && bytes[i] < 48 && bytes[i] > 57; i++) {}

		let count = 0;
		let lookup = ASCIILOOKUP[bytes[i]];

		for (; i < bytes.length && !(lookup & 0x10); i++) {
			lookup = ASCIILOOKUP[bytes[i]];
			count = count * 10 + lookup;
		}

		return count;
	}

	function parse_command(argc, arguments) {
		let i = 0;
		if (argc < 3) return false;
		while (arguments[i++][0] === "-") {
			switch (arguments[i][1]) {
				case "b": {
					config.mpeg.bitr = __atoi(argv[++i], 2);
					break;
				}
				case "c": {
					config.mpeg.copyright = 1;
					break;
				}
				case "r": {
					raw = true;
					break;
				}
				default: {
					return false;
				}
			}
		}
		if ((argc - i) !== 2) return false;
		config.infile  = argv[i++];
		config.outfile = argv[i];
		return true;
	}

	const mpeg1_sampleRate = new Int16Array([44100,48000,32000]);
	const mpeg1_bitrate = new Int16Array([0,32,40,48,56,64,80,96,112,128,160,192,224,256,320]);
	const mode_names    = [ "stereo", "j-stereo", "dual-ch", "mono" ];
	const layer_names   = [ "I", "II", "III" ];
	const version_names = [ "MPEG-II (LSF)", "MPEG-I" ];
	const psy_names     = [ "", "MUSICAM", "Shine" ];
	const demp_names    = [ "none", "50/15us", "", "CITT" ];

	function find_samplerate_index(freq) {
		let i = 0;
		for(i=0;i<3;i++)if(freq==mpeg1_sampleRate[i])return i;
		error("Invalid samplerate");
	}

	function find_bitrate_index(freq) {
		let i = 0;
		for(i=0;i<15;i++)if(freq==mpeg1_bitrate[i])return i;
		error("Invalid bitrate");
	}

	function check_config() {
		config.mpeg.samplerate_index = find_samplerate_index(config.wave.samplerate);
		config.mpeg.bitrate_index    = find_bitrate_index(config.mpeg.bitr);

		printf("%s layer %s, %s  Psychoacoustic Model: %s\n", version_names[config.mpeg.type], layer_names[config.mpeg.layr],  mode_names[config.mpeg.mode], psy_names[config.mpeg.psyc]);
  		printf("Bitrate=%d kbps  ",config.mpeg.bitr );
  		printf("De-emphasis: %s   %s %s\n", demp_names[config.mpeg.emph], ((config.mpeg.original)?"Original":""), ((config.mpeg.copyright)?"(C)":""));
	}

	function main(string = "", disk = DISK) {
		let arguments = [];
		let argc = 0;
		{
			arguments = string.match(/"[^"]+"|\S+/g) || [];
			argc = arguments.length;
		}
		printf("ARM Shine v1.00(SA) 24/03/01\n");
		set_defaults();

		if (!parse_command(arguments, argc)) {
			print_usage();
			throw new Error("EXIT CODE 1");
		}

		filetype = readtype(config.infile);

		if (raw) wave_open(DATA); else {
			switch(filetype) {
				case WAVE:
				case DATA:
					wave_open(filetype);
					break;
				default: wave_open(WAVE);
			}
		}

		check_config();
		printf("Encoding \"%s\" to \"%s\"\n", config.infile, config.outfile);
		L3_compress();
		wave_close();

		console.warn("This is not a part of the original C library. The time debugging is temporarily unimplemented in this port.");
	}

	main.out = DISK;

	return main;
})();
